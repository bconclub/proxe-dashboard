name: Deploy Windchasers Dashboard

on:
  push:
    branches:
      - production
      - main
    paths:
      - 'brand/windchasers/dashboard/build/**'
      - '.github/workflows/deploy-windchasers-dashboard.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Increment build version
        working-directory: brand/windchasers/dashboard/build
        run: |
          node scripts/increment-build.js
      
      - name: Commit version bump
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add brand/windchasers/dashboard/build/package.json brand/windchasers/dashboard/build/.build-info
          git commit -m "chore: auto-increment build version [skip ci]" || echo "No changes to commit"
          git push || echo "Nothing to push"
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.WINDCHASERS_VPS_SSH_KEY }}
      
      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.WINDCHASERS_VPS_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to VPS via Rsync
        run: |
          rsync -avz --delete \
            --exclude='.env.local' \
            --exclude='node_modules' \
            --exclude='.next' \
            --exclude='.git' \
            --exclude='*.log' \
            --exclude='.DS_Store' \
            -e "ssh -o StrictHostKeyChecking=no" \
            brand/windchasers/dashboard/build/ \
            ${{ secrets.WINDCHASERS_VPS_USER }}@${{ secrets.WINDCHASERS_VPS_HOST }}:/var/www/windchasers-proxe/
      
      - name: Deploy PM2 Ecosystem Config
        run: |
          rsync -avz \
            -e "ssh -o StrictHostKeyChecking=no" \
            brand/windchasers/dashboard/build/ecosystem.config.js \
            ${{ secrets.WINDCHASERS_VPS_USER }}@${{ secrets.WINDCHASERS_VPS_HOST }}:/var/www/windchasers-proxe/ecosystem.config.js
      
      - name: Build and Restart on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.WINDCHASERS_VPS_HOST }}
          username: ${{ secrets.WINDCHASERS_VPS_USER }}
          key: ${{ secrets.WINDCHASERS_VPS_SSH_KEY }}
          port: 22
          timeout: 300s
          script: |
            cd /var/www/windchasers-proxe
            
            # Preserve existing .env.local if it exists
            if [ ! -f .env.local ]; then
              echo "‚ö†Ô∏è  Warning: .env.local not found on VPS. Please create it manually."
            fi
            
            # Clean previous build to avoid chunk mismatches
            echo "üßπ Cleaning previous build..."
            rm -rf .next
            rm -rf node_modules/.cache
            
            # Install dependencies (need dev deps for build)
            echo "üì¶ Installing dependencies..."
            npm ci
            
            # Build the application
            echo "üèóÔ∏è  Building Next.js application..."
            npm run build
            
            # Check build exit code
            BUILD_EXIT_CODE=$?
            if [ $BUILD_EXIT_CODE -ne 0 ]; then
              echo "‚ùå ERROR: Build failed with exit code: $BUILD_EXIT_CODE"
              echo "Checking for build errors..."
              exit 1
            fi
            
            # Verify build succeeded
            if [ ! -d ".next" ]; then
              echo "‚ùå ERROR: Build failed - .next directory not found!"
              echo "Current directory contents:"
              ls -la
              exit 1
            fi
            
            # Verify critical build files exist
            if [ -f ".next/BUILD_ID" ]; then
              echo "‚úÖ BUILD_ID found: $(cat .next/BUILD_ID)"
            else
              echo "‚ö†Ô∏è  WARNING: BUILD_ID not found, but build may still be successful"
            fi
            
            # Check for static chunks directory
            if [ -d ".next/static/chunks" ]; then
              CHUNK_COUNT=$(find .next/static/chunks -name "*.js" | wc -l)
              echo "‚úÖ Found $CHUNK_COUNT chunk files"
              if [ "$CHUNK_COUNT" -lt 10 ]; then
                echo "‚ö†Ô∏è  WARNING: Very few chunks found, build might be incomplete"
              fi
            else
              echo "‚ùå ERROR: .next/static/chunks directory not found!"
              exit 1
            fi
            
            # Verify build manifest exists
            if [ -f ".next/BUILD_MANIFEST" ] || [ -f ".next/build-manifest.json" ]; then
              echo "‚úÖ Build manifest found"
            else
              echo "‚ö†Ô∏è  WARNING: Build manifest not found"
            fi
            
            echo "‚úÖ Build verification complete"
            
            # Create logs directory if it doesn't exist
            mkdir -p logs
            
            # Restart or start with PM2 ecosystem file
            echo "üîÑ Restarting application with PM2 ecosystem..."
            if [ -f ecosystem.config.js ]; then
              # Use ecosystem file if it exists
              pm2 restart ecosystem.config.js --only windchasers-dashboard || \
              pm2 start ecosystem.config.js --only windchasers-dashboard
            else
              # Fallback to individual process
              PORT=3003 pm2 restart windchasers-proxe || \
              PORT=3003 pm2 start npm --name windchasers-proxe -- start
            fi
            
            # Save PM2 configuration
            pm2 save
            
            # Wait for app to start
            echo "‚è≥ Waiting for app to start..."
            sleep 10
            
            # Health check with retries (check both /health and /api/health)
            MAX_RETRIES=5
            RETRY_COUNT=0
            HEALTH_CHECK_PASSED=false
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              # Try /api/health first (more detailed)
              if curl -f http://localhost:3003/api/health > /dev/null 2>&1; then
                echo "‚úÖ Health check passed (/api/health)"
                HEALTH_CHECK_PASSED=true
                # Get detailed health info
                curl -s http://localhost:3003/api/health | head -20
                break
              # Fallback to /health
              elif curl -f http://localhost:3003/health > /dev/null 2>&1; then
                echo "‚úÖ Health check passed (/health)"
                HEALTH_CHECK_PASSED=true
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                echo "‚è≥ Health check attempt $RETRY_COUNT/$MAX_RETRIES failed, retrying..."
                sleep 3
              fi
            done
            
            if [ "$HEALTH_CHECK_PASSED" = false ]; then
              echo "‚ö†Ô∏è  Health check failed after $MAX_RETRIES attempts"
              echo "Checking PM2 logs..."
              pm2 logs windchasers-dashboard --lines 20 --nostream || true
              echo "‚ö†Ô∏è  Deployment completed but health check failed - please verify manually"
            fi
            
            # Show PM2 status
            echo "‚úÖ Deployment complete. PM2 status:"
            pm2 list | grep windchasers-proxe || echo "‚ö†Ô∏è  Process not found in PM2 list"
