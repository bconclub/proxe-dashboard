name: Deploy Windchasers Web-Agent

on:
  push:
    branches:
      - production
      - main
    paths:
      - 'brand/windchasers/web-agent/build/**'
      - '.github/workflows/deploy-windchasers-web-agent.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.WINDCHASERS_VPS_SSH_KEY }}
      
      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.WINDCHASERS_VPS_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to VPS via Rsync
        run: |
          rsync -avz --delete \
            --exclude='.env.local' \
            --exclude='node_modules' \
            --exclude='.next' \
            --exclude='.git' \
            --exclude='*.log' \
            --exclude='.DS_Store' \
            -e "ssh -o StrictHostKeyChecking=no" \
            brand/windchasers/web-agent/build/ \
            ${{ secrets.WINDCHASERS_VPS_USER }}@${{ secrets.WINDCHASERS_VPS_HOST }}:/var/www/windchasers-web-agent/
      
      - name: Build and Restart on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.WINDCHASERS_VPS_HOST }}
          username: ${{ secrets.WINDCHASERS_VPS_USER }}
          key: ${{ secrets.WINDCHASERS_VPS_SSH_KEY }}
          port: 22
          timeout: 300s
          script: |
            cd /var/www/windchasers-web-agent
            
            # Create logs directory if it doesn't exist
            mkdir -p logs
            
            # Preserve existing .env.local if it exists
            if [ ! -f .env.local ]; then
              echo "‚ö†Ô∏è  Warning: .env.local not found on VPS. Please create it manually."
            fi
            
            # Install dependencies (need dev deps for build)
            echo "üì¶ Installing dependencies..."
            npm ci
            
            # Build the application
            echo "üèóÔ∏è  Building Next.js application..."
            npm run build
            
            # Check build exit code
            BUILD_EXIT_CODE=$?
            if [ $BUILD_EXIT_CODE -ne 0 ]; then
              echo "‚ùå ERROR: Build failed with exit code: $BUILD_EXIT_CODE"
              echo "Checking for build errors..."
              exit 1
            fi
            
            # Verify build succeeded
            if [ ! -d ".next" ]; then
              echo "‚ùå ERROR: Build failed - .next directory not found!"
              echo "Current directory contents:"
              ls -la
              exit 1
            fi
            
            echo "‚úÖ Build successful - .next directory exists"
            
            # Restart using PM2 ecosystem (if exists) or individual process
            echo "üîÑ Restarting web-agent with PM2..."
            if [ -f /var/www/windchasers-proxe/ecosystem.config.js ]; then
              # Use ecosystem file if it exists
              pm2 restart ecosystem.config.js --only windchasers-web-agent || \
              pm2 start /var/www/windchasers-proxe/ecosystem.config.js --only windchasers-web-agent
            else
              # Fallback to individual process
              PORT=3001 pm2 restart windchasers-web-agent || \
              PORT=3001 pm2 start npm --name windchasers-web-agent -- start
            fi
            
            # Save PM2 configuration
            pm2 save
            
            # Wait for app to start
            sleep 5
            
            # Health check
            curl -f http://localhost:3001/widget || echo "‚ö†Ô∏è  Health check failed"
            
            # Show PM2 status
            echo "‚úÖ Deployment complete. PM2 status:"
            pm2 list | grep windchasers-web-agent || echo "‚ö†Ô∏è  Process not found in PM2 list"
